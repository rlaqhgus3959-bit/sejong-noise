<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§‘ì‹œë²• ì†ŒìŒ ê¸°ì¤€ ê³„ì‚°ê¸°</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 24px 16px;
            background: #f2f2f7;
            color: #1c1c1e;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        .container { max-width: 500px; margin: 0 auto; }
        .header { padding: 10px 0 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 22px; font-weight: 700; color: #000; }
        
        .card {
            background: #fff;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .input-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; border-bottom: 1px solid #e5e5ea;
        }
        .input-row:last-child { border-bottom: none; }
        .input-row label { font-size: 15px; font-weight: 500; }
        .input-row select, .input-row input {
            border: none; text-align: right; font-size: 16px;
            color: #007aff; background: transparent; width: 50%; outline: none;
        }

        .btn-group { display: flex; gap: 8px; margin-bottom: 24px; }
        button {
            flex: 2; padding: 16px; font-size: 17px; font-weight: 600;
            color: white; background: #007aff; border: none; border-radius: 12px;
            cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.2);
        }
        .btn-clear { flex: 1; background: #8e8e93; font-size: 14px; }
        button:active { opacity: 0.8; transform: scale(0.98); }

        .history-title {
            font-size: 18px; font-weight: 700; margin: 20px 0 12px 4px;
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .result-card {
            background: #fff; border-radius: 18px; padding: 18px;
            margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #f2f2f7;
        }
        .timestamp { font-size: 12px; color: #8e8e93; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .badge-pass { background: #e8f5e9; color: #2e7d32; }
        .badge-fail { background: #ffebee; color: #c62828; }
        .badge-none { background: #f5f5f7; color: #636366; }

        .data-grid { display: grid; gap: 8px; }
        .data-row { display: flex; justify-content: space-between; font-size: 14px; }
        .row-label { color: #8e8e93; font-size: 11px; margin-top: 8px; font-weight: 600; }
        .row-value { font-weight: 600; color: #1c1c1e; }
        .sub-val { font-size: 12px; color: #8e8e93; font-weight: 400; }
        .result-highlight { font-weight: 700; }
        .violation-text { color: #ff3b30; }

        .footer { margin-top: 40px; padding: 20px; text-align: center; }
        .footer .agency {
            display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: 600; color: #1c1c1e;
        }
        .footer .agency::before { content: "ğŸš”"; margin-right: 8px; font-size: 20px; }
        .footer .dept { font-size: 12px; color: #8e8e93; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>ì§‘ì‹œë²• ì†ŒìŒ ê¸°ì¤€ ê³„ì‚°ê¸°</h1></div>

        <div class="card">
            <div class="input-row">
                <label>ëŒ€ìƒ ì§€ì—­</label>
                <select id="region">
                    <option value="residential">ì£¼ê±°ì§€ì—­Â·í•™êµÂ·ì¢…í•©ë³‘ì›</option>
                    <option value="library">ê³µê³µë„ì„œê´€</option>
                    <option value="other">ê·¸ ë°–ì˜ ì§€ì—­</option>
                </select>
            </div>
            <div class="input-row">
                <label>ì‹œê°„ëŒ€</label>
                <select id="time">
                    <option value="day">ì£¼ê°„</option>
                    <option value="evening">ì•¼ê°„</option>
                    <option value="night" selected>ì‹¬ì•¼</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="input-row">
                <label>ë°°ê²½ì†ŒìŒ Leq</label>
                <input type="number" id="bg" step="0.1" value="55.2">
            </div>
            <div class="input-row">
                <label>ì¸¡ì •ì†ŒìŒ Leq</label>
                <input type="number" id="meas" step="0.1" value="58.8">
            </div>
            <div class="input-row">
                <label>ìµœê³ ì†ŒìŒ Lmax</label>
                <input type="number" id="lmax" step="0.1" value="70.0">
            </div>
        </div>

        <div class="btn-group">
            <button onclick="calculate()">ê³„ì‚°í•˜ê¸°</button>
            <button class="btn-clear" onclick="clearHistory()">ê¸°ë¡ ì‚­ì œ</button>
        </div>

        <div id="history-section">
            <div class="history-title" id="history-title" style="display:none;">ì¸¡ì • ê¸°ë¡ (ìµœì‹ ìˆœ)</div>
            <div id="history-list"></div>
        </div>

        <footer class="footer">
            <div class="agency">ì„¸ì¢…ë¶ë¶€ê²½ì°°ì„œ</div>
            <div class="dept">ê²½ë¹„ì‘ì „ê³„</div>
        </footer>
    </div>

    <script>
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì €ì¥ëœ ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    window.onload = function() {
        const saved = localStorage.getItem('noiseHistory');
        if (saved) {
            document.getElementById('history-list').innerHTML = saved;
            document.getElementById('history-title').style.display = 'flex';
        }
    }

    function getCorrectionValue(diff) {
        if (diff < 3.0) return null;
        if (diff >= 10.0) return 0;
        if (diff >= 3.0 && diff <= 3.3) return 3.0;
        if (diff >= 3.4 && diff <= 3.8) return 2.5;
        if (diff >= 3.9 && diff <= 4.3) return 2.0;
        if (diff >= 4.4 && diff <= 5.3) return 1.5;
        if (diff >= 5.4 && diff <= 6.7) return 1.0;
        if (diff >= 6.8 && diff <= 9.9) return 0.5;
        return (10 * Math.log10(1 / (1 - Math.pow(10, -diff/10)))).toFixed(1);
    }

    function getUserCorrection(diff) {
        if (diff == 3.6) return 2.5;
        if (diff == 3.7) return 2.4;
        return getCorrectionValue(diff);
    }

    function getStandardLimits(region, time) {
        if (region === "residential" || region === "library") {
            if (time === "day") return [65, 85];
            if (time === "evening") return [60, 80];
            if (time === "night") return [55, 75];
        } else {
            if (time === "day") return [75, 95];
            if (time === "evening") return [65, 85];
            if (time === "night") return [65, 85];
        }
        return [55, 75];
    }

    function calculate() {
        const region = document.getElementById('region').value;
        const time = document.getElementById('time').value;
        const [stdLeq, stdLmax] = getStandardLimits(region, time);
        const bg = parseFloat(document.getElementById('bg').value);
        const meas = parseFloat(document.getElementById('meas').value);
        const lmaxRaw = parseFloat(document.getElementById('lmax').value) || 0;

        if (isNaN(bg) || isNaN(meas)) return alert("ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const isBgHigh = bg > stdLeq;
        const appliedLimitLeq = isBgHigh ? Math.ceil(bg) : stdLeq;
        const appliedLimitLmax = appliedLimitLeq + 20;
        const diff = (meas - bg).toFixed(1);
        const corr = getUserCorrection(diff);
        
        const now = new Date();
        const timeString = now.getMonth()+1 + "/" + now.getDate() + " " + now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

        let cardHTML = '';
        if (corr === null) {
            cardHTML = `
                <div class="result-card">
                    <div class="card-header"><span class="timestamp">${timeString}</span><span class="badge badge-none">ì œì™¸</span></div>
                    <div class="data-grid"><div class="data-row"><span>ì°¨ì´ ${diff}dB (3dB ë¯¸ë§Œ)</span><span class="row-value">ë°°ê²½ì†ŒìŒ ì˜í–¥ ì§€ë°°ì </span></div></div>
                </div>`;
        } else {
            const rawResultLeq = (meas - corr).toFixed(1);
            const finalLeq = Math.round(rawResultLeq); 
            const finalLmax = Math.round(lmaxRaw);
            const leqViolation = finalLeq > appliedLimitLeq;
            const lmaxViolation = finalLmax > appliedLimitLmax;
            const isViolation = leqViolation || lmaxViolation;

            cardHTML = `
                <div class="result-card" id="latest-result">
                    <div class="card-header">
                        <span class="timestamp">${timeString}</span>
                        <span class="badge ${isViolation ? 'badge-fail' : 'badge-pass'}">${isViolation ? 'ê¸°ì¤€ ì´ˆê³¼' : 'ê¸°ì¤€ ì¤€ìˆ˜'}</span>
                    </div>
                    <div class="row-label">1. ì ìš© ê¸°ì¤€ (Leq / Lmax)</div>
                    <div class="data-row"><span class="row-value">${appliedLimitLeq} dB / ${appliedLimitLmax} dB</span></div>
                    
                    <div class="row-label">2. ë³´ì •ê°’ (Leq - ë³´ì •ì¹˜)</div>
                    <div class="data-row"><span>${rawResultLeq} dB <span class="sub-val">(-${corr})</span></span></div>

                    <div class="row-label">3. ìµœì¢… íŒì • (ë°˜ì˜¬ë¦¼)</div>
                    <div class="data-row"><span>ë“±ê°€(Leq)</span><span class="row-value ${leqViolation ? 'violation-text' : ''}">${finalLeq} dB ${leqViolation ? 'ìœ„ë°˜' : ''}</span></div>
                    <div class="data-row"><span>ìµœê³ (Lmax)</span><span class="row-value ${lmaxViolation ? 'violation-text' : ''}">${finalLmax} dB ${lmaxViolation ? 'ìœ„ë°˜' : ''}</span></div>
                </div>`;
        }

        const historyList = document.getElementById('history-list');
        historyList.insertAdjacentHTML('afterbegin', cardHTML);
        document.getElementById('history-title').style.display = 'flex';
        
        // ë¡œì»¬ ì €ì¥ì†Œì— ì €ì¥ (ë¸Œë¼ìš°ì € êº¼ë„ ìœ ì§€)
        localStorage.setItem('noiseHistory', historyList.innerHTML);

        // ê³„ì‚° í›„ ê²°ê³¼ ìœ„ì¹˜ë¡œ ìë™ ìŠ¤í¬ë¡¤
        setTimeout(() => {
            document.getElementById('history-title').scrollIntoView({ behavior: 'smooth' });
        }, 100);
    }

    function clearHistory() {
        if(confirm("ëª¨ë“  ì¸¡ì • ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('noiseHistory');
            document.getElementById('history-list').innerHTML = '';
            document.getElementById('history-title').style.display = 'none';
        }
    }
    </script>
</body>
</html>
