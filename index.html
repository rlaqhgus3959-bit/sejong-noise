<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§‘ì‹œë²• ì†ŒìŒ ê¸°ì¤€ ê³„ì‚°ê¸°</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 24px 16px;
            background: #f2f2f7; /* iOS ë² ì´ìŠ¤ ì»¬ëŸ¬ */
            color: #1c1c1e;
            min-height: 100vh;
        }
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        .header {
            padding: 20px 0 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 700;
            color: #000000;
        }
        
        /* ì…ë ¥ í¼ ì¹´ë“œ */
        .card {
            background: #ffffff;
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .input-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            border-bottom: 1px solid #e5e5ea;
        }
        .input-row:last-child {
            border-bottom: none;
        }
        .input-row label {
            font-size: 16px;
            color: #000000;
            flex-shrink: 0;
            margin-right: 16px;
            font-weight: 500;
        }
        .input-row select, .input-row input {
            border: none;
            text-align: right;
            font-size: 16px;
            color: #007aff;
            background: transparent;
            width: 60%;
            outline: none;
            font-family: inherit;
        }

        button {
            width: 100%;
            padding: 16px;
            font-size: 17px;
            font-weight: 600;
            color: white;
            background: #007aff;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0,122,255,0.2);
        }
        button:active {
            background: #0062cc;
            transform: scale(0.99);
        }

        /* ê¸°ë¡ ì˜ì—­ ìŠ¤íƒ€ì¼ */
        .history-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 12px;
            margin-left: 4px;
            color: #1c1c1e;
            display: none; /* ë‚´ìš© ì—†ì„ ë•Œ ìˆ¨ê¹€ */
        }
        
        /* ê°œë³„ ê²°ê³¼ ì¹´ë“œ (íˆìŠ¤í† ë¦¬ ì•„ì´í…œ) */
        .result-card {
            background: #ffffff;
            border-radius: 18px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.06);
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            border: 1px solid rgba(0,0,0,0.02);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ê²°ê³¼ ì¹´ë“œ í—¤ë” (ì‹œê°„, íŒì •) */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f2f2f7;
        }
        .timestamp {
            font-size: 13px;
            color: #8e8e93;
            font-weight: 600;
        }
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
        }
        .badge-pass { background: #e8f5e9; color: #2e7d32; } /* ì´ˆë¡ */
        .badge-fail { background: #ffebee; color: #c62828; } /* ë¹¨ê°• */
        .badge-none { background: #f5f5f7; color: #636366; } /* íšŒìƒ‰ */

        /* ê²°ê³¼ ë°ì´í„° ê·¸ë¦¬ë“œ */
        .data-grid {
            display: grid;
            gap: 12px;
        }
        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 15px;
        }
        .row-label {
            color: #8e8e93;
            font-weight: 500;
            font-size: 13px;
            text-transform: uppercase;
            margin-top: 10px;
            margin-bottom: 4px;
        }
        .row-value {
            font-weight: 600;
            color: #1c1c1e;
        }
        .sub-val {
            font-size: 13px;
            color: #8e8e93;
            font-weight: 400;
            margin-left: 4px;
        }
        
        .result-highlight {
            font-weight: 700;
            color: #000000;
        }
        .violation-text { color: #ff3b30; }

        /* í‘¸í„° ìŠ¤íƒ€ì¼ ìˆ˜ì • (ì•„ì´ì½˜ CSSë¡œ ë³µêµ¬) */
        .footer {
            margin-top: 40px;
            padding: 20px;
            text-align: center;
        }
        .footer .agency {
            display: flex; /* ì•„ì´ì½˜ê³¼ í…ìŠ¤íŠ¸ ì •ë ¬ */
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
            color: #1c1c1e;
            margin-bottom: 4px;
        }
        /* ì—¬ê¸°ì„œ ì•„ì´ì½˜ì„ í‘œì‹œí•©ë‹ˆë‹¤ */
        .footer .agency::before {
            content: "ğŸš”"; 
            margin-right: 8px;
            font-size: 22px;
        }
        .footer .dept {
            font-size: 12px;
            color: #8e8e93;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ì§‘ì‹œë²• ì†ŒìŒ ê¸°ì¤€ ê³„ì‚°ê¸°</h1>
        </div>

        <div class="card">
            <div class="input-row">
                <label>ëŒ€ìƒ ì§€ì—­</label>
                <select id="region">
                    <option value="residential">ì£¼ê±°ì§€ì—­Â·í•™êµÂ·ì¢…í•©ë³‘ì›</option>
                    <option value="library">ê³µê³µë„ì„œê´€</option>
                    <option value="other">ê·¸ ë°–ì˜ ì§€ì—­</option>
                </select>
            </div>
            <div class="input-row">
                <label>ì‹œê°„ëŒ€</label>
                <select id="time">
                    <option value="day">ì£¼ê°„</option>
                    <option value="evening">ì•¼ê°„</option>
                    <option value="night" selected>ì‹¬ì•¼</option>
                </select>
            </div>
        </div>

        <div class="card">
            <div class="input-row">
                <label>ë°°ê²½ì†ŒìŒ Leq</label>
                <input type="number" id="bg" step="0.1" value="55.2" placeholder="dB">
            </div>
            <div class="input-row">
                <label>ì¸¡ì •ì†ŒìŒ Leq</label>
                <input type="number" id="meas" step="0.1" value="58.8" placeholder="dB">
            </div>
            <div class="input-row">
                <label>ìµœê³ ì†ŒìŒ Lmax</label>
                <input type="number" id="lmax" step="0.1" value="70.0" placeholder="dB">
            </div>
        </div>

        <button onclick="calculate()">ê³„ì‚°í•˜ê¸°</button>

        <div id="history-section">
            <div class="history-title" id="history-title">ì¸¡ì • ê¸°ë¡ (ìµœì‹ ìˆœ)</div>
            <div id="history-list"></div>
        </div>

        <footer class="footer">
            <div class="agency">ì„¸ì¢…ë¶ë¶€ê²½ì°°ì„œ</div> <div class="dept">ê²½ë¹„ì‘ì „ê³„</div>
        </footer>
    </div>

    <script>
    // [ê³„ì‚° ë¡œì§/ë°ì´í„° ìœ ì§€]
    function getCorrectionValue(diff) {
        if (diff < 3.0) return null;
        if (diff >= 10.0) return 0;
        
        if (diff >= 3.0 && diff <= 3.3) return 3.0;
        if (diff >= 3.4 && diff <= 3.8) return 2.5;
        if (diff >= 3.9 && diff <= 4.3) return 2.0;
        if (diff >= 4.4 && diff <= 5.3) return 1.5;
        if (diff >= 5.4 && diff <= 6.7) return 1.0;
        if (diff >= 6.8 && diff <= 9.9) return 0.5;
        
        return (10 * Math.log10(1 / (1 - Math.pow(10, -diff/10)))).toFixed(1);
    }

    function getUserCorrection(diff) {
        if (diff == 3.6) return 2.5;
        if (diff == 3.7) return 2.4;
        return getCorrectionValue(diff);
    }

    function getStandardLimits(region, time) {
        if (region === "residential" || region === "library") {
            if (time === "day")     return [65, 85];
            if (time === "evening") return [60, 80];
            if (time === "night")   return [55, 75];
        } else {
            if (time === "day")     return [75, 95];
            if (time === "evening") return [65, 85];
            if (time === "night")   return [65, 85];
        }
        return [55, 75];
    }

    // ë©”ì¸ ê³„ì‚° ë° íˆìŠ¤í† ë¦¬ ì¶”ê°€ í•¨ìˆ˜
    function calculate() {
        const region = document.getElementById('region').value;
        const time   = document.getElementById('time').value;
        const [stdLeq, stdLmax] = getStandardLimits(region, time);

        const bg   = parseFloat(document.getElementById('bg').value);
        const meas = parseFloat(document.getElementById('meas').value);
        const lmaxRaw = parseFloat(document.getElementById('lmax').value) || 0;

        if (isNaN(bg) || isNaN(meas)) return alert("ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const isBgHigh = bg > stdLeq;
        const appliedLimitLeq  = isBgHigh ? Math.ceil(bg) : stdLeq;
        const appliedLimitLmax = appliedLimitLeq + 20;

        const diff = (meas - bg).toFixed(1);
        const corr = getUserCorrection(diff);
        
        // í˜„ì¬ ì‹œê°„ êµ¬í•˜ê¸°
        const now = new Date();
        const timeString = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

        // íˆìŠ¤í† ë¦¬ ì¹´ë“œ ìƒì„±
        const historyList = document.getElementById('history-list');
        const historyTitle = document.getElementById('history-title');
        const card = document.createElement('div');
        card.className = 'result-card';

        // 1. ì¸¡ì • ì œì™¸ (3dB ë¯¸ë§Œ) ì¼€ì´ìŠ¤
        if (corr === null) {
            card.innerHTML = `
                <div class="card-header">
                    <span class="timestamp">${timeString}</span>
                    <span class="badge badge-none">ì¸¡ì • ì œì™¸</span>
                </div>
                <div class="data-grid">
                    <div class="row-label">ìƒì„¸ ì‚¬ìœ </div>
                    <div class="data-row">
                        <span>ì†ŒìŒ ì°¨ì´</span>
                        <span class="row-value">${diff} dB</span>
                    </div>
                    <div class="data-row">
                        <span>ê²°ê³¼</span>
                        <span class="row-value" style="color:#636366">ë°°ê²½ì†ŒìŒ ì˜í–¥ (3dB ë¯¸ë§Œ)</span>
                    </div>
                </div>
            `;
        } 
        // 2. ì •ìƒ ê³„ì‚° ì¼€ì´ìŠ¤
        else {
            const rawResultLeq = (meas - corr).toFixed(1);
            const finalLeq = Math.round(rawResultLeq); 
            const finalLmax = Math.round(lmaxRaw);

            const leqViolation  = finalLeq > appliedLimitLeq;
            const lmaxViolation = finalLmax > appliedLimitLmax;
            const isViolation   = leqViolation || lmaxViolation;

            const badgeClass = isViolation ? 'badge-fail' : 'badge-pass';
            const badgeText = isViolation ? 'ê¸°ì¤€ ì´ˆê³¼' : 'ê¸°ì¤€ ì¤€ìˆ˜';

            // ìš”ì²­í•˜ì‹  ìˆœì„œ: ê¸°ì¤€ -> ë³´ì • -> ìµœì¢…
            card.innerHTML = `
                <div class="card-header">
                    <span class="timestamp">${timeString}</span>
                    <span class="badge ${badgeClass}">${badgeText}</span>
                </div>

                <div class="row-label">1. ê¸°ì¤€ ì†ŒìŒ</div>
                <div class="data-row">
                    <span>ë“±ê°€ (Leq)</span>
                    <span class="row-value">${appliedLimitLeq} dB</span>
                </div>
                <div class="data-row" style="margin-bottom: 8px;">
                    <span>ìµœê³  (Lmax)</span>
                    <span class="row-value">${appliedLimitLmax} dB</span>
                </div>

                <div class="row-label" style="border-top:1px dashed #e5e5ea; padding-top:8px;">2. ë³´ì • ì†ŒìŒ</div>
                <div class="data-row">
                    <span>ë“±ê°€ (Leq)</span>
                    <span class="row-value">${rawResultLeq} dB <span class="sub-val">(-${corr})</span></span>
                </div>
                <div class="data-row" style="margin-bottom: 8px;">
                    <span>ìµœê³  (Lmax)</span>
                    <span class="row-value">${lmaxRaw} dB</span>
                </div>

                <div class="row-label" style="border-top:1px dashed #e5e5ea; padding-top:8px;">3. ìµœì¢… íŒì •</div>
                <div class="data-row">
                    <span>ë“±ê°€ (Leq)</span>
                    <span class="row-value result-highlight ${leqViolation ? 'violation-text' : ''}">
                        ${finalLeq} dB
                        ${leqViolation ? ' (ìœ„ë°˜)' : ''}
                    </span>
                </div>
                <div class="data-row">
                    <span>ìµœê³  (Lmax)</span>
                    <span class="row-value result-highlight ${lmaxViolation ? 'violation-text' : ''}">
                        ${finalLmax} dB
                        ${lmaxViolation ? ' (ìœ„ë°˜)' : ''}
                    </span>
                </div>
            `;
        }

        // ë¦¬ìŠ¤íŠ¸ ìµœìƒë‹¨ì— ì¶”ê°€ (ìµœì‹ ìˆœ)
        historyList.prepend(card);
        historyTitle.style.display = 'block'; // íƒ€ì´í‹€ ë³´ì´ê¸°
    }
    </script>
</body>
</html>
