<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì§‘ì‹œë²• ì†ŒìŒ ê¸°ì¤€ ê³„ì‚°ê¸°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 24px 16px; background: #f2f2f7; color: #1c1c1e; min-height: 100vh; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 500px; margin: 0 auto; }
        .header { padding: 10px 0 20px; text-align: center; }
        .header h1 { margin: 0; font-size: 22px; font-weight: 700; color: #000; }
        .card { background: #fff; border-radius: 14px; overflow: hidden; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .input-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-bottom: 1px solid #e5e5ea; }
        .input-row:last-child { border-bottom: none; }
        .input-row label { font-size: 15px; font-weight: 500; }
        .input-row select, .input-row input { border: none; text-align: right; font-size: 16px; color: #007aff; background: transparent; width: 50%; outline: none; }
        .btn-group { display: flex; gap: 8px; margin-bottom: 24px; }
        button { flex: 2; padding: 16px; font-size: 17px; font-weight: 600; color: white; background: #007aff; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,122,255,0.2); }
        .btn-clear { flex: 1; background: #8e8e93; font-size: 14px; }
        .history-title { font-size: 18px; font-weight: 700; margin: 20px 0 12px 4px; display: flex; justify-content: space-between; align-items: center; }
        .result-card { background: #fff; border-radius: 18px; padding: 18px; margin-bottom: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid #f2f2f7; }
        .timestamp { font-size: 12px; color: #8e8e93; }
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .badge-pass { background: #e8f5e9; color: #2e7d32; }
        .badge-fail { background: #ffebee; color: #c62828; }
        .badge-none { background: #f5f5f7; color: #636366; }
        .data-row { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 5px; }
        .row-label { color: #8e8e93; font-size: 11px; margin-top: 10px; font-weight: 600; margin-bottom: 4px; }
        .row-value { font-weight: 600; color: #1c1c1e; }
        .sub-val { font-size: 12px; color: #8e8e93; font-weight: 400; }
        .violation-text { color: #ff3b30; }
        .footer { margin-top: 40px; padding: 20px; text-align: center; }
        .footer .agency { display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 600; color: #1c1c1e; }
        .footer .agency::before { content: "ğŸš”"; margin-right: 8px; font-size: 20px; }
        .footer .dept { font-size: 12px; color: #8e8e93; margin-top: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header"><h1>ì§‘ì‹œë²• ì†ŒìŒ ê¸°ì¤€ ê³„ì‚°ê¸°</h1></div>
        <div class="card">
            <div class="input-row">
                <label>ëŒ€ìƒ ì§€ì—­</label>
                <select id="region">
                    <option value="residential">ì£¼ê±°ì§€ì—­Â·í•™êµÂ·ì¢…í•©ë³‘ì›</option>
                    <option value="library">ê³µê³µë„ì„œê´€</option>
                    <option value="other">ê·¸ ë°–ì˜ ì§€ì—­</option>
                </select>
            </div>
            <div class="input-row">
                <label>ì‹œê°„ëŒ€</label>
                <select id="time">
                    <option value="day">ì£¼ê°„</option>
                    <option value="evening">ì•¼ê°„</option>
                    <option value="night" selected>ì‹¬ì•¼</option>
                </select>
            </div>
        </div>
        <div class="card">
            <div class="input-row"><label>ë°°ê²½ì†ŒìŒ Leq</label><input type="number" id="bg" step="0.1" value="50.0"></div>
            <div class="input-row"><label>ì¸¡ì •ì†ŒìŒ Leq</label><input type="number" id="meas" step="0.1" value="53.4"></div>
            <div class="input-row"><label>ìµœê³ ì†ŒìŒ Lmax</label><input type="number" id="lmax" step="0.1" value="70.0"></div>
        </div>
        <div class="btn-group">
            <button onclick="calculate()">ê³„ì‚°í•˜ê¸°</button>
            <button class="btn-clear" onclick="clearHistory()">ê¸°ë¡ ì‚­ì œ</button>
        </div>
        <div id="history-section">
            <div class="history-title" id="history-title" style="display:none;">ì¸¡ì • ê¸°ë¡ (ìµœì‹ ìˆœ)</div>
            <div id="history-list"></div>
        </div>
        <footer class="footer"><div class="agency">ì„¸ì¢…ë¶ë¶€ê²½ì°°ì„œ</div><div class="dept">ê²½ë¹„ì‘ì „ê³„</div></footer>
    </div>

    <script>
    window.onload = function() {
        const saved = localStorage.getItem('noiseHistory');
        if (saved) {
            document.getElementById('history-list').innerHTML = saved;
            document.getElementById('history-title').style.display = 'flex';
        }
    }

    // [ì¤‘ìš”] ì‚¬ìš©ì ì œê³µ ì¡°ê²¬í‘œ ë°ì´í„° ë§¤í•‘ (ì ˆëŒ€ ìˆ˜ì • ê¸ˆì§€)
    const correctionTable = {
        "3.0": 3.0, "3.1": 2.9, "3.2": 2.8, "3.3": 2.7, "3.4": 2.7, "3.5": 2.6, "3.6": 2.5, "3.7": 2.4, "3.8": 2.3, "3.9": 2.3,
        "4.0": 2.2, "4.1": 2.1, "4.2": 2.1, "4.3": 2.0, "4.4": 2.0, "4.5": 1.9, "4.6": 1.8, "4.7": 1.8, "4.8": 1.7, "4.9": 1.7,
        "5.0": 1.7, "5.1": 1.6, "5.2": 1.6, "5.3": 1.5, "5.4": 1.5, "5.5": 1.4, "5.6": 1.4, "5.7": 1.4, "5.8": 1.3, "5.9": 1.3,
        "6.0": 1.3, "6.1": 1.2, "6.2": 1.2, "6.3": 1.2, "6.4": 1.1, "6.5": 1.1, "6.6": 1.1, "6.7": 1.0, "6.8": 1.0, "6.9": 1.0,
        "7.0": 1.0, "7.1": 0.9, "7.2": 0.9, "7.3": 0.9, "7.4": 0.9, "7.5": 0.9, "7.6": 0.8, "7.7": 0.8, "7.8": 0.8, "7.9": 0.8,
        "8.0": 0.7, "8.1": 0.7, "8.2": 0.7, "8.3": 0.7, "8.4": 0.7, "8.5": 0.7, "8.6": 0.6, "8.7": 0.6, "8.8": 0.6, "8.9": 0.6,
        "9.0": 0.6, "9.1": 0.6, "9.2": 0.6, "9.3": 0.5, "9.4": 0.5, "9.5": 0.5, "9.6": 0.5, "9.7": 0.5, "9.8": 0.5, "9.9": 0.5
    };

    function getCorrectionValue(diff) {
        if (diff < 3.0) return null;
        if (diff >= 10.0) return 0;
        // ë¬¸ìì—´ í‚¤ë¡œ ë³€í™˜í•˜ì—¬ í…Œì´ë¸”ì—ì„œ ê°’ ì¡°íšŒ
        const key = diff.toFixed(1);
        return correctionTable[key] !== undefined ? correctionTable[key] : 0;
    }

    // ìš”ì²­í•˜ì‹  ì†ŒìŒ ê¸°ì¤€ ì ìš©
    function getStandardLimits(region, time) {
        if (region === "residential") {
            if (time === "day") return [60, 80];
            if (time === "evening") return [50, 70];
            if (time === "night") return [45, 65];
        } else if (region === "library") {
            if (time === "day") return [60, 80];
            if (time === "evening") return [55, 75];
            if (time === "night") return [55, 75];
        } else { // ê·¸ ë°–ì˜ ì§€ì—­
            if (time === "day") return [70, 90];
            if (time === "evening") return [60, 90];
            if (time === "night") return [60, 90];
        }
        return [60, 80];
    }

    function calculate() {
        const region = document.getElementById('region').value;
        const time = document.getElementById('time').value;
        const [stdLeq, stdLmax] = getStandardLimits(region, time);
        const bg = parseFloat(document.getElementById('bg').value);
        const meas = parseFloat(document.getElementById('meas').value);
        const lmaxRaw = parseFloat(document.getElementById('lmax').value) || 0;

        if (isNaN(bg) || isNaN(meas)) return alert("ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        const diffRaw = meas - bg;
        // ì°¨ì´ê°’ ì†Œìˆ˜ì  ì²«ì§¸ìë¦¬ê¹Œì§€ ê³ ì • (ì¡°ê²¬í‘œ ë§¤ì¹­ìš©)
        const diff = parseFloat(diffRaw.toFixed(1));
        const corr = getCorrectionValue(diff);
        
        // ë°°ê²½ì†ŒìŒì´ ê¸°ì¤€ì„ ì´ˆê³¼í•˜ë©´ ë°°ê²½ì†ŒìŒì„ ê¸°ì¤€ê°’ìœ¼ë¡œ ì‚¬ìš© (ì˜¬ë¦¼)
        const isBgHigh = bg > stdLeq;
        const appliedLimitLeq = isBgHigh ? Math.ceil(bg) : stdLeq;
        
        // Lmax ê¸°ì¤€ì€ ê³ ì •ëœ ë²•ì  ê¸°ì¤€ ì‚¬ìš© (ë°°ê²½ì†ŒìŒ ì—°ë™ X - ìš”ì²­ì‚¬í•­ ë°˜ì˜)
        const appliedLimitLmax = stdLmax;

        const now = new Date();
        const timeString = (now.getMonth()+1) + "/" + now.getDate() + " " + now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });

        let cardHTML = '';
        if (corr === null) {
            cardHTML = `
                <div class="result-card">
                    <div class="card-header"><span class="timestamp">${timeString}</span><span class="badge badge-none">ì¬ì¸¡ì •</span></div>
                    <div class="data-row"><span>ì°¨ì´ ${diff}dB (3dB ë¯¸ë§Œ)</span><span class="row-value">ë°°ê²½ì†ŒìŒ ì˜í–¥ ì§€ë°°ì </span></div>
                </div>`;
        } else {
            // ê³„ì‚°ì‹: ì¸¡ì •ì¹˜ - ë³´ì •ì¹˜ (ì‚¬ìš©ì í‘œì˜ ë³´ì •ì¹˜ëŠ” ëº„ì…ˆìš© ì–‘ìˆ˜ë¡œ ì €ì¥ë¨)
            const rawResultLeq = (meas - corr).toFixed(1);
            const finalLeq = Math.round(parseFloat(rawResultLeq)); 
            const finalLmax = Math.round(lmaxRaw);
            const leqViolation = finalLeq > appliedLimitLeq;
            const lmaxViolation = finalLmax > appliedLimitLmax;
            const isViolation = leqViolation || lmaxViolation;

            cardHTML = `
                <div class="result-card">
                    <div class="card-header">
                        <span class="timestamp">${timeString}</span>
                        <span class="badge ${isViolation ? 'badge-fail' : 'badge-pass'}">${isViolation ? 'ê¸°ì¤€ ì´ˆê³¼' : 'ê¸°ì¤€ ì¤€ìˆ˜'}</span>
                    </div>
                    
                    <div class="row-label">1. ì ìš© ê¸°ì¤€ (Leq / Lmax)</div>
                    <div class="data-row"><span class="row-value">${appliedLimitLeq} dB / ${appliedLimitLmax} dB</span></div>
                    
                    <div class="row-label">2. ë³´ì •ê°’ ì ìš© (ì°¨ì´: ${diff}dB)</div>
                    <div class="data-row"><span>ë³´ì • ì „: ${meas} dB</span><span>ë³´ì •ì¹˜: <span style="color:#007aff;">-${corr}</span></span></div>
                    <div class="data-row"><span>ë³´ì • í›„: ${rawResultLeq} dB</span></div>

                    <div class="row-label">3. ìµœì¢… íŒì • (ë°˜ì˜¬ë¦¼)</div>
                    <div class="data-row"><span>ë“±ê°€(Leq)</span><span class="row-value ${leqViolation ? 'violation-text' : ''}">${finalLeq} dB ${leqViolation ? 'ìœ„ë°˜' : ''}</span></div>
                    <div class="data-row"><span>ìµœê³ (Lmax)</span><span class="row-value ${lmaxViolation ? 'violation-text' : ''}">${finalLmax} dB ${lmaxViolation ? 'ìœ„ë°˜' : ''}</span></div>
                </div>`;
        }

        const historyList = document.getElementById('history-list');
        historyList.insertAdjacentHTML('afterbegin', cardHTML);
        document.getElementById('history-title').style.display = 'flex';
        
        localStorage.setItem('noiseHistory', historyList.innerHTML);
        setTimeout(() => { document.getElementById('history-title').scrollIntoView({ behavior: 'smooth' }); }, 100);
    }

    function clearHistory() {
        if(confirm("ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem('noiseHistory');
            document.getElementById('history-list').innerHTML = '';
            document.getElementById('history-title').style.display = 'none';
        }
    }
    </script>
</body>
</html>
